<template>
    <div>
        <iv-visualisation :title="pageName" :vue_config="vue_config" :page_number="1">
            <template #hotspots>
                <iv-pane position="left" format="overlay">
                    <iv-sidebar-content>
                        <iv-sidebar-section title="Guidance" icon="star">
                            Directions on how to use vis
                        </iv-sidebar-section>
                    </iv-sidebar-content>
                </iv-pane>
                <iv-toggle-hotspot position="bottom">
                    <div style="display:block;" id="buttons">
                    <iv-button>Add Plane</iv-button>
                    <iv-button>Add Line</iv-button>
                    <iv-button>Add Point</iv-button>
                    </div>
                </iv-toggle-hotspot>
                <iv-toggle-hotspot position="right" title="Equations">
                    <div id="equations">
                    <div id="plane1">
                        <label style="border-left: solid 20px rgb(0,146,146); padding-left: 1px;">Plane 1:</label>
                        <input id="a1Input" type="number" value="1" style="width: 70px"> x +
                        <input id="b1Input" type="number" value="0" style="width: 70px"> y +
                        <input id="c1Input" type="number" value="0" style="width: 70px"> z =
                        <input id="d1Input" type="number" value="3" style="width: 70px">
                    </div>
                    <div id="plane2" hidden>
                        <label style="border-left: solid 20px rgb(219,209,0); padding-left: 1px;">Plane 2:</label>
                        <input id="a2Input" type="number" value="0" style="width: 70px"> x +
                        <input id="b2Input" type="number" value="1" style="width: 70px"> y +
                        <input id="c2Input" type="number" value="0" style="width: 70px"> z =
                        <input id="d2Input" type="number" value="3" style="width: 70px">
                        <span id="plane2Close" class="closeBtn closeBtnH">×</span>
                    </div>
                    <div id="plane3" hidden>
                        <label style="border-left: solid 20px rgb(182,109,255); padding-left: 1px;">Plane 3:</label>
                        <input id="a3Input" type="number" value="0" style="width: 70px"> x +
                        <input id="b3Input" type="number" value="0" style="width: 70px"> y +
                        <input id="c3Input" type="number" value="1" style="width: 70px"> z =
                        <input id="d3Input" type="number" value="3" style="width: 70px">
                        <span id="plane3Close" class="closeBtn closeBtnH">×</span>
                    </div>
                    <br>
                    <div id="line01" hidden>
                        <label style="border-left: solid 4px rgb(0,0,0); padding-left: 17px;">Line 1:</label>
                        <table class='matrixWrapper'><tbody>
                            <tr>
                                <td>Point:&nbsp;</td>
                                <td>(&nbsp;
                                    <input id="e1Input" type="number" value="0" style="width: 70px; line-height: 0;">,&nbsp;
                                    <input id="f1Input" type="number" value="0" style="width: 70px; line-height: 0;">,&nbsp;
                                    <input id="g1Input" type="number" value="0" style="width: 70px; line-height: 0;">&nbsp;)
                                </td>
                            </tr>
                            <tr>
                                <td>Direction Vector:&nbsp;;</td>
                                <td>(&nbsp;
                                    <input id="i1Input" type="number" value="-1" style="width: 70px">,&nbsp;
                                    <input id="j1Input" type="number" value="1" style="width: 70px">,&nbsp;
                                    <input id="k1Input" type="number" value="1" style="width: 70px">&nbsp;)
                                </td>
                            </tr>
                        </tbody></table>
                        <span id="line01Close" class="closeBtn closeBtnH" style="margin-top: -90px;">×</span>
                    </div>
                    <div id="line02" hidden>
                        <label style="border-left: solid 4px #7ec0ee; padding-left: 17px;">Line 2:</label>
                        <table class='matrixWrapper'><tbody>
                            <tr>
                                <td>Point:&nbsp;</td>
                                <td>(&nbsp;
                                    <input id="e2Input" type="number" value="0" style="width: 70px; line-height: 0;">,&nbsp;
                                    <input id="f2Input" type="number" value="0" style="width: 70px; line-height: 0;">,&nbsp;
                                    <input id="g2Input" type="number" value="0" style="width: 70px; line-height: 0;"> &nbsp;)
                                </td>
                            </tr>
                            <tr>
                                <td>Direction Vector:&nbsp;</td>
                                <td>(&nbsp;
                                    <input id="i2Input" type="number" value="1" style="width: 70px">,&nbsp;
                                    <input id="j2Input" type="number" value="-1" style="width: 70px">,&nbsp;
                                    <input id="k2Input" type="number" value="1" style="width: 70px"> &nbsp;)
                                </td>
                            </tr>
                        </tbody></table>
                        <span id="line02Close" class="closeBtn closeBtnH" style="margin-top: -90px;">×</span>
                    </div>
                    <br>
                    <div id="point1" hidden>
                        <label>• &nbsp; Point 1:</label>
                        (
                        <input id="xInput" type="number" value="0" style="width: 70px"> ,&nbsp;
                        <input id="yInput" type="number" value="0" style="width: 70px"> ,&nbsp;
                        <input id="zInput" type="number" value="0" style="width: 70px">
                        )
                        <span id="point1Close" class="closeBtn closeBtnH">×</span>
                    </div>
                </div>
                </iv-toggle-hotspot>
            </template>
        </iv-visualisation>
    </div>
</template>
<script src="./util/objects.js"></script>
<script>
import vue_config from '../../vue.config.js'
export default {
    name:"intersections",
    data(){
        return {
            pageName:"Intersections",
            vue_config
        }
    },
    mounted(){
        var layout = {
    width: 450, height: 500,
    margin: {l:0, r:0, t:50, b:0},
    hovermode: "closest",
    showlegend: false,
    scene: {
        camera: {
            eye: {x: 1.2, y: 1.2, z: 1.2},
            center: {x: 0, y: 0, z: -0.15}
        },
        xaxis: {range:[-50, 50], zeroline: true, scaleratio: 1},
        yaxis: {range:[-50, 50], zeroline: true, scaleratio: 1},
        zaxis: {range:[-50, 50], zeroline: true, scaleratio: 1},
        aspectratio: {x:1, y:1, z:1},
    }
};

var isInterShown = false;
var planeCounter = 1, lineCounter = 0, pointCounter = 0; // eslint-disable-line no-unused-vars

function addEmptyObjects3d(data, numberObj){
    for (var i=0; i < numberObj; ++i){
        data.push({
            type: "scatter3d",
            mode: "lines",
            x:[0,0],
            y:[0,0],
            z:[0,0],
            line: {width: 0}
        });
    }
    return;
}

function addPlane(data, a, b, c, d, color) {
    var x, y, z;

    if (Math.abs(c) > 1e-10) {
        x = [-50, 50, 50, -50],
        y = [-50, -50, 50, 50];
        z = [];
        for (var i=0; i<4; ++i) {
            z.push(-( d + a*x[i] + b*y[i] )/c );
        }
    } else if (Math.abs(b) > 1e-10) {
        x = [-50, 50, 50, -50],
        z = [-50, -50, 50, 50];
        y = [];
        for (var j=0; j<4; ++j) {
            y.push(-( d + a*x[j] + c*z[j] )/b );
        }
    } else if (Math.abs(a) > 1e-10) {
        y = [-50, 50, 50, -50],
        z = [-50, -50, 50, 50];
        x = [];
        for (var k=0; k<4; ++k) {
            x.push(-( d + b*y[k] + c*z[k] )/a );
        }
    } else {
        return 1; // not a plane.
    }

    var plane = {
        type: "mesh3d",
        x: x, y: y, z: z,
        i: [0, 2], j: [1, 3], k: [2, 0],
        opacity: 0.5,
        colorscale: [['0', color], ['1', white]],
        intensity: [0, 0.1, 0.2, 0.3, 0.5, 0.6, 0.8, 1],
        showscale: false
    };
    data.push(plane)
    return 0;
}

function addIntersection(data, point, normal, a1, b1, c1, d1, a2, b2, c2, d2, color){
    normal[0] = b1*c2 - b2*c1;
    normal[1] = a2*c1 - a1*c2;
    normal[2] = a1*b2 - a2*b1;

    var x;
    if (a1*b2 - b1*a2 != 0) {
        // z = 0
        x = math.lusolve([[a1, b1], [a2, b2]], [-d1, -d2]);
        for (var i=0; i<2; ++i){
            point.push(x[i][0]);
        }
        point.push(0);
    } else if (a1*c2 - c1*a2 != 0) {
        // y = 0
        x = math.lusolve([[a1, c1], [a2, c2]], [-d1, -d2]);
        point.push(x[0][0]);
        point.push(0);
        point.push(x[1][0]);
    } else if (b1*c2 - c1*b2 != 0) {
        // x = 0
        x = math.lusolve([[b1, c1], [b2, c2]], [-d1, -d2]);
        point.push(0);
        for (var i=0; i<2; ++i){
            point.push(x[i][0]);
        }
    } else {
        addEmptyObjects3d(data, 1);
        return 1;
    }

    increaseMag(normal, 100);
    data.push({
        type: "scatter3d",
        mode: "lines",
        x: [point[0] - normal[0], point[0] + normal[0]],
        y: [point[1] - normal[1], point[1] + normal[1]],
        z: [point[2] - normal[2], point[2] + normal[2]],
        line: {color: color, width: 8}
    });

    normalise(normal);
    sig2(normal);
    sig2(point);

    return 0;
}

function addLine(data, point, direction, color){
    increaseMag(direction, 100);
    data.push({
        type: "scatter3d",
        mode: "lines",
        x: [point[0] - direction[0], point[0] + direction[0]],
        y: [point[1] - direction[1], point[1] + direction[1]],
        z: [point[2] - direction[2], point[2] + direction[2]],
        line: {color: color, width: 8}
    });
    return 0;
}

function addPoint(data, point, color){
    data.push({
        type: "scatter3d",
        mode: "markers",
        x: [point[0]],
        y: [point[1]],
        z: [point[2]],
        marker: {color: color, width: 8}
    });
    return 0;
}

function increaseMag(value, limit) {
    for (var i=0; i<value.length; ++i){
        if(value[i] !== 0){
            while (Math.abs(value[i]) < limit){
                value[i] *= 10;
            }
        }
    }
    return 0;
}

function normalise(value) {
    var mag = math.norm(value);
    if (mag !== 0){
        for (var i=0; i<value.length; ++i){
            value[i] = value[i]/mag;
        }
    }
    return 0;
}

function sig2(value) {
    for (var i=0; i<value.length; ++i){
        value[i] = Math.round(value[i]*100)/100;
    }
    return 0;
}

function init() {
    Plotly.purge("graph");

    var data = [];
    const
        a1 = parseFloat($("#a1Input").val()), b1 = parseFloat($("#b1Input").val()),
        c1 = parseFloat($("#c1Input").val()), d1 = parseFloat($("#d1Input").val());
    addPlane(data, a1, b1, c1, d1, cyan);

    Plotly.newPlot("graph", data, layout);
    return 0;
}

function compute(data) {
    const
        a1 = parseFloat($("#a1Input").val()), b1 = parseFloat($("#b1Input").val()),
        c1 = parseFloat($("#c1Input").val()), d1 = parseFloat($("#d1Input").val()),
        a2 = parseFloat($("#a2Input").val()), b2 = parseFloat($("#b2Input").val()),
        c2 = parseFloat($("#c2Input").val()), d2 = parseFloat($("#d2Input").val()),
        a3 = parseFloat($("#a3Input").val()), b3 = parseFloat($("#b3Input").val()),
        c3 = parseFloat($("#c3Input").val()), d3 = parseFloat($("#d3Input").val()),

        e1 = parseFloat($("#e1Input").val()), i1 = parseFloat($("#i1Input").val()),
        f1 = parseFloat($("#f1Input").val()), j1 = parseFloat($("#j1Input").val()),
        g1 = parseFloat($("#g1Input").val()), k1 = parseFloat($("#k1Input").val()),
        e2 = parseFloat($("#e2Input").val()), i2 = parseFloat($("#i2Input").val()),
        f2 = parseFloat($("#f2Input").val()), j2 = parseFloat($("#j2Input").val()),
        g2 = parseFloat($("#g2Input").val()), k2 = parseFloat($("#k2Input").val()),

        x = parseFloat($("#xInput").val()), y = parseFloat($("#yInput").val()), z = parseFloat($("#zInput").val());

    var point, direction;
    if(!$("#plane1").is(":hidden")){addPlane(data, a1, b1, c1, d1, cyan);};
    if(!$("#plane2").is(":hidden")){addPlane(data, a2, b2, c2, d2, orange);};
    if(!$("#plane3").is(":hidden")){addPlane(data, a3, b3, c3, d3, lilac);};

    if (!$("#plane1").is(":hidden") && !$("#plane2").is(":hidden")) {
        point = []; direction = [];
        addIntersection(data, point, direction, a1, b1, c1, d1, a2, b2, c2, d2, "rgb(0,255,0)");
        $("#intersection1").text("Plane 1 & Plane 2: " + "Point: " + point + " " + "Direction: " + direction);
    }
    if (!$("#plane2").is(":hidden") && !$("#plane3").is(":hidden")) {
        point = []; direction = [];
        addIntersection(data, point, direction, a2, b2, c2, d2, a3, b3, c3, d3, "rgb(255,0,0)");
        $("#intersection2").text("Plane 2 & Plane 3: " + "Point: " + point + " " + "Direction: " + direction);
    }
    if (!$("#plane1").is(":hidden") && !$("#plane3").is(":hidden")) {
        point = []; direction = [];
        addIntersection(data, point, direction, a1, b1, c1, d1, a3, b3, c3, d3, "rgb(0,0,255)");
        $("#intersection3").text("Plane 1 & Plane 3: " + "Point: " + point + " " + "Direction: " + direction);
    }

    if(!$("#line01").is(":hidden")){addLine(data, [e1, f1, g1], [i1, j1, k1], black);};
    if(!$("#line02").is(":hidden")){addLine(data, [e2, f2, g2], [i2, j2, k2], "#7ec0ee");};

    if(!$("#point1").is(":hidden")){addPoint(data, [x, y, z], black);};


    return 0;
}

function update() {
    Plotly.purge("graph");
    var data = [];
    var error = compute(data);

    updateIntersection();
    Plotly.newPlot("graph", data, layout);
    return 0;
}

function updateIntersection() {
    if(isInterShown){
        hideIntersection();
        if (!$("#plane1").is(":hidden") && !$("#plane2").is(":hidden")) {
            $("#intersection1").show();
        }
        if (!$("#plane2").is(":hidden") && !$("#plane3").is(":hidden")) {
            $("#intersection2").show();
        }
        if (!$("#plane1").is(":hidden") && !$("#plane3").is(":hidden")) {
            $("#intersection3").show();
        }
    } else{
        hideIntersection();
    }


    return 0;
}

function hideIntersection() {
    $("#intersection1").hide();
    $("#intersection2").hide();
    $("#intersection3").hide();
    return 0;
}

function updateButtons() {
    $("#addPlane").prop("disabled",false);
    $("#addLine").prop("disabled",false);
    $("#addPoint").prop("disabled",false);
    if (!$("#plane2").is(":hidden") && !$("#plane3").is(":hidden")){
        $("#addPlane").prop("disabled",true);
    }
    if (!$("#line01").is(":hidden") && !$("#line02").is(":hidden")){
        $("#addLine").prop("disabled",true);
    }
    if (!$("#point1").is(":hidden")){
        $("#addPoint").prop("disabled",true);
    }
    return 0;
}

function main() {
    $("input[type=number]").each(function () {
        $(this).on('keyup',function () {
            if(event.keyCode == 13) {
                let n = $(this).val();
                if( n.match(/^-?\d*(\.\d+)?$/) && !isNaN(parseFloat(n)) ){
                    $("#inputError").hide();
                    if( parseFloat(n) > -51 && parseFloat(n) < 51){
                        update();
                    } else{
                        $("#inputError").text("Invalid input: min = -50, max = 50");
                        $("#inputError").show();
                    }
                } else{
                    $("#inputError").text("Invalid input: the input needs to be a number");
                    $("#inputError").show();
                }
            }
        });
    });

    $("input[type=button]").click(function () {
        if ($(this).attr("id") === "addPlane"){
            if ($("#plane2").is(":hidden")) {
                $("#plane2").show();
            } else if ($("#plane3").is(":hidden")) {
                $("#plane3").show();
            }
        } else if ($(this).attr("id") === "addLine") {
            if ($("#line01").is(":hidden")) {
                $("#line01").show();
            } else if ($("#line02").is(":hidden")) {
                $("#line02").show();
            }
        } else if ($(this).attr("id") === "addPoint") {
            $("#point1").show();
        }
        update();
        updateButtons();
    });

    $("input[type=submit]").click(function () {
        if ($(this).attr("id") === "showIntersection") {
            isInterShown = !isInterShown;
            updateIntersection();
            document.getElementById("showIntersection").value = (isInterShown) ?
            "Hide Equations of Intersection Lines":"Show Equations of Intersection Lines";
        }
    });

    $(".closeBtn").click(function () {
        $("#" + $(this).attr("id").slice(0,6)).hide();
        update();
        updateButtons();
    });

    $(".guide").click(function () {
        isInterShown = false;
        hideIntersection();
        document.getElementById("showIntersection").value = "Show Equations of Intersection Lines";
    });

    init();
    initGuidance(["graph", "addButtons", "equations", "showIntersection"]);
}
$(document).ready(main);
    }
}
</script>
<style>
 #buttons > *:not(:last-child){
     margin-right: 7px;
 }
</style>